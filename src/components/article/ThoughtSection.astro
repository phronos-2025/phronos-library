---
import type { Citation, LegendItem } from '../../data/essay-sections';

interface Props {
  number: number;
  numeral: string;
  title: string;
  subtitle: string;
  coreThought: string;
  deepDive: string;
  citations: Citation[];
  sectionId: string;
  legend?: LegendItem[];
}

const { number, numeral, title, subtitle, coreThought, deepDive, citations, sectionId, legend } = Astro.props;
const hasLegend = legend && legend.length > 0;
const totalCitationCount = citations.reduce((sum, c) => sum + (c.citationCount ?? 0), 0);
---

<section
  class="thought-unit"
  id={sectionId}
  data-section={number}
  itemscope
  itemtype="https://schema.org/ArticleSection"
>
  <div class="text-block">
    <!-- Section header: numeral + titles -->
    <div class="section-header">
      <span class="section-numeral" aria-hidden="true">{numeral}</span>
      <div class="section-titles">
        <h2 class="section-title" itemprop="name">{title}</h2>
        <p class="section-subtitle">{subtitle}</p>
      </div>
    </div>

    {/* Visual legend: miniature icons for elements introduced in this section */}
    {hasLegend && (
      <div class="section-legend" aria-label="Visual elements introduced in this section">
        {legend.map((item) => (
          <div class="legend-item">
            <svg class="legend-icon" viewBox="0 0 24 14" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              {item.icon === 'particle' && (
                <>
                  <circle cx="12" cy="7" r="3.5" fill={item.color} />
                  <circle cx="12" cy="7" r="5.5" fill="none" stroke={item.color} stroke-opacity="0.3" stroke-width="0.75" />
                </>
              )}
              {item.icon === 'halo-particle' && (
                <>
                  {/* Particle with pulsing halo rings */}
                  <circle cx="12" cy="7" r="2.5" fill={item.color} />
                  <circle cx="12" cy="7" r="4.5" fill="none" stroke={item.color} stroke-opacity="0.55" stroke-width="0.6" class="legend-halo-1" />
                  <circle cx="12" cy="7" r="6.5" fill="none" stroke={item.color} stroke-opacity="0.3" stroke-width="0.5" class="legend-halo-2" />
                </>
              )}
              {item.icon === 'bond' && (
                <>
                  <circle cx="4" cy="7" r="2.5" fill={item.color} />
                  <line x1="6.5" y1="7" x2="17.5" y2="7" stroke={item.color2 || item.color} stroke-width="0.75" stroke-opacity="0.6" />
                  <circle cx="20" cy="7" r="2.5" fill={item.color2 || item.color} />
                </>
              )}
              {item.icon === 'grid' && (
                <>
                  {/* Small 3x3 grid of lines */}
                  <line x1="4" y1="2" x2="4" y2="12" stroke={item.color} stroke-width="0.6" />
                  <line x1="9" y1="2" x2="9" y2="12" stroke={item.color} stroke-width="0.6" />
                  <line x1="14" y1="2" x2="14" y2="12" stroke={item.color} stroke-width="0.6" />
                  <line x1="19" y1="2" x2="19" y2="12" stroke={item.color} stroke-width="0.6" />
                  <line x1="2" y1="4" x2="21" y2="4" stroke={item.color} stroke-width="0.6" />
                  <line x1="2" y1="7" x2="21" y2="7" stroke={item.color} stroke-width="0.6" />
                  <line x1="2" y1="10" x2="21" y2="10" stroke={item.color} stroke-width="0.6" />
                </>
              )}
              {item.icon === 'convexity' && (
                <>
                  {/* Grid bump / convexity — concentric contour arcs rising from a surface */}
                  <ellipse cx="12" cy="10" rx="10" ry="2" fill="none" stroke={item.color} stroke-width="0.4" stroke-opacity="0.25" />
                  <ellipse cx="12" cy="9" rx="7" ry="2.5" fill="none" stroke={item.color} stroke-width="0.5" stroke-opacity="0.4" />
                  <ellipse cx="12" cy="7.5" rx="4.5" ry="2.5" fill="none" stroke={item.color} stroke-width="0.6" stroke-opacity="0.55" />
                  <ellipse cx="12" cy="6" rx="2" ry="1.5" fill="none" stroke={item.color} stroke-width="0.7" stroke-opacity="0.7" />
                </>
              )}
              {item.icon === 'entity' && (
                <>
                  {/* Translucent sphere with radial gradient */}
                  <defs>
                    <radialGradient id={`eg-${sectionId}-${item.label.replace(/\s/g, '')}`} cx="40%" cy="35%" r="55%">
                      <stop offset="0%" stop-color={item.color} stop-opacity="0.8" />
                      <stop offset="100%" stop-color={item.color} stop-opacity="0.15" />
                    </radialGradient>
                  </defs>
                  <circle cx="12" cy="7" r="6" fill={`url(#eg-${sectionId}-${item.label.replace(/\s/g, '')})`} />
                  <circle cx="12" cy="7" r="6" fill="none" stroke={item.color} stroke-opacity="0.3" stroke-width="0.5" />
                </>
              )}
              {item.icon === 'floor' && (
                <>
                  {/* Row of small dots along a line */}
                  <circle cx="3" cy="9" r="1.5" fill={item.color} />
                  <circle cx="7.5" cy="8" r="1" fill={item.color} fill-opacity="0.7" />
                  <circle cx="11" cy="9.5" r="1.3" fill={item.color} />
                  <circle cx="14.5" cy="8.5" r="0.8" fill={item.color} fill-opacity="0.6" />
                  <circle cx="17.5" cy="9" r="1.2" fill={item.color} />
                  <circle cx="21" cy="8.5" r="1" fill={item.color} fill-opacity="0.8" />
                  <line x1="1" y1="11" x2="23" y2="11" stroke={item.color} stroke-width="0.4" stroke-opacity="0.3" />
                </>
              )}
            </svg>
            <span class="legend-label">{item.label}</span>
          </div>
        ))}
      </div>
    )}

    <!-- Core Thought: always visible, optimized as featured snippet -->
    <div class="core-thought" itemprop="abstract">
      <Fragment set:html={coreThought} />
    </div>

    {(deepDive.trim() || citations.length > 0) && (
      <>
        <!-- Expand indicator (clickable toggle) -->
        <button class="expand-indicator" type="button" aria-controls={`dd-${sectionId}`} aria-label="Toggle deep dive">
          <span class="expand-line"></span>
          <span class="expand-label">Deep Dive</span>
          <span class="expand-chevron" aria-hidden="true">&#x25BE;</span>
          <span class="expand-line"></span>
        </button>

        <!-- Deep Dive: hidden via CSS grid trick, revealed on click -->
        <div
          class="deep-dive-wrapper"
          id={`dd-${sectionId}`}
          aria-expanded="false"
          itemprop="text"
        >
          <div class="deep-dive-inner">
            <Fragment set:html={deepDive} />

            {citations.length > 0 && (
              <div class="section-citations">
                <button
                  class="citations-toggle"
                  type="button"
                  aria-controls={`cites-${sectionId}`}
                  aria-expanded="false"
                >
                  <span class="citations-toggle-label">
                    Sources
                    <span class="citations-total-count">(Total Citation Count: {totalCitationCount.toLocaleString()})</span>
                  </span>
                  <span class="citations-chevron" aria-hidden="true">&#x25BE;</span>
                </button>
                <div class="citations-collapsible" id={`cites-${sectionId}`}>
                  <ol class="citations-list">
                    {citations.map((cite) => (
                      <li class="citation-item">
                        <span class="citation-authors">{cite.authors}</span>
                        {` (${cite.year}). `}
                        <span class="citation-title">&ldquo;{cite.title}.&rdquo;</span>
                        {" "}
                        <em class="citation-pub">{cite.publication}</em>.
                        {cite.doi && (
                          <a
                            href={`https://doi.org/${cite.doi}`}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="citation-doi"
                          >
                            DOI
                          </a>
                        )}
                        {cite.citationCount !== undefined && cite.citationCount > 0 && (
                          <span class="citation-count">
                            {cite.citationCount.toLocaleString()} citations
                          </span>
                        )}
                      </li>
                    ))}
                  </ol>
                </div>
              </div>
            )}
          </div>
        </div>
      </>
    )}
  </div>
</section>

<style>
  /* ── Section container — full viewport height ────────── */
  .thought-unit {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 4rem 0;
    box-sizing: border-box;
    border-bottom: none;
    content-visibility: auto;
    contain-intrinsic-size: auto 1000px;
  }

  .thought-unit:last-child {
    border-bottom: none;
  }

  /* ── Text block: the visible card ──────────────────── */
  .text-block {
    padding: 2.5rem;
    border-left: 1px solid rgba(255, 255, 255, 0.1);
  }

  /* ── Header ─────────────────────────────────────────── */
  .section-header {
    display: flex;
    align-items: baseline;
    gap: 1.25rem;
    margin-bottom: 2rem;
  }

  .section-numeral {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--gold);
    letter-spacing: 0.5px;
    flex-shrink: 0;
    line-height: 1;
    padding-top: 0.15rem;
  }

  .section-titles {
    flex: 1;
  }

  .section-title {
    font-family: var(--font-display);
    font-size: var(--text-xl);
    font-weight: 400;
    color: var(--ink);
    margin: 0;
    line-height: 1.2;
  }

  .section-subtitle {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--faded);
    margin: 0.35rem 0 0;
  }

  /* ── Legend ──────────────────────────────────────────── */
  .section-legend {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1rem;
    margin: 0.5rem 0 1.75rem;
  }

  .legend-item {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
  }

  .legend-icon {
    width: 24px;
    height: 14px;
    flex-shrink: 0;
  }

  .legend-label {
    font-family: var(--font-mono);
    font-size: 0.6rem;
    text-transform: uppercase;
    letter-spacing: 0.75px;
    color: var(--faded);
    line-height: 1;
  }

  /* Pulsing halo animation for constrained-particle icon */
  :global(.legend-halo-1) {
    animation: legend-pulse 2.5s ease-in-out infinite;
  }

  :global(.legend-halo-2) {
    animation: legend-pulse 2.5s ease-in-out infinite 0.4s;
  }

  @keyframes legend-pulse {
    0%, 100% { opacity: 0.25; }
    50% { opacity: 0.7; }
  }

  /* ── Core Thought ───────────────────────────────────── */
  .core-thought {
    margin-bottom: 1.5rem;
  }

  .core-thought :global(p) {
    font-family: var(--font-body);
    font-size: var(--text-base);
    line-height: 1.8;
    color: var(--ink);
    margin: 0 0 1rem;
  }

  .core-thought :global(p:last-child) {
    margin-bottom: 0;
  }

  .core-thought :global(strong) {
    font-weight: 600;
  }

  /* ── Expand indicator (clickable) ───────────────────── */
  .expand-indicator {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin: 1.5rem 0;
    width: 100%;
    padding: 0.5rem 0;
    border: none;
    background: none;
    cursor: pointer;
    transition: opacity var(--transition-normal);
  }

  .expand-indicator:hover {
    opacity: 0.8;
  }

  .expand-indicator:hover .expand-label {
    text-decoration: underline;
    text-underline-offset: 3px;
  }

  .expand-line {
    flex: 1;
    height: 1px;
    background: var(--faded-light);
  }

  .expand-label {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: rgba(242, 220, 160, 0.9);
    flex-shrink: 0;
    transition: text-decoration 0.2s ease;
  }

  .expand-chevron {
    font-size: 0.8rem;
    color: rgba(242, 220, 160, 0.9);
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    flex-shrink: 0;
    line-height: 1;
  }

  :global(.thought-unit.expanded) .expand-chevron {
    transform: rotate(180deg);
  }

  :global(.thought-unit.expanded) .expand-indicator {
    opacity: 0.4;
  }

  /* ── Deep Dive wrapper (grid trick for animation) ───── */
  .deep-dive-wrapper {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.8s cubic-bezier(0.16, 1, 0.3, 1),
                opacity 0.6s ease;
    opacity: 0;
    overflow: hidden;
  }

  .deep-dive-inner {
    min-height: 0;
  }

  :global(.thought-unit.expanded) .deep-dive-wrapper {
    grid-template-rows: 1fr;
    opacity: 1;
  }

  /* ── Deep Dive content ──────────────────────────────── */
  .deep-dive-inner :global(p) {
    font-family: var(--font-body);
    font-size: 0.95rem;
    line-height: 1.85;
    color: var(--ink);
    margin: 0 0 1.25rem;
  }

  .deep-dive-inner :global(p:last-child) {
    margin-bottom: 0;
  }

  /* ── Citations ──────────────────────────────────────── */
  .section-citations {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: var(--border-divider);
  }

  .citations-toggle {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0;
    border: none;
    background: none;
    cursor: pointer;
    margin: 0;
    transition: opacity var(--transition-fast);
  }

  .citations-toggle:hover {
    opacity: 0.7;
  }

  .citations-toggle-label {
    font-family: var(--font-mono);
    font-size: 0.6rem;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--faded);
    font-weight: 600;
  }

  .citations-total-count {
    font-weight: 400;
    margin-left: 0.35rem;
    letter-spacing: 0.75px;
  }

  .citations-chevron {
    font-size: 0.8rem;
    color: var(--faded);
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    flex-shrink: 0;
    line-height: 1;
  }

  .citations-toggle[aria-expanded="true"] .citations-chevron {
    transform: rotate(180deg);
  }

  .citations-collapsible {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.5s cubic-bezier(0.16, 1, 0.3, 1),
                opacity 0.4s ease,
                margin 0.5s ease;
    opacity: 0;
    overflow: hidden;
    margin-top: 0;
  }

  .citations-collapsible.is-open {
    grid-template-rows: 1fr;
    opacity: 1;
    margin-top: 1rem;
  }

  .citations-collapsible > .citations-list {
    min-height: 0;
  }

  .citations-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .citation-item {
    font-family: var(--font-body);
    font-size: 0.8rem;
    line-height: 1.6;
    color: var(--faded);
  }

  .citation-authors {
    color: var(--ink);
    font-weight: 500;
  }

  .citation-title {
    font-style: normal;
  }

  .citation-pub {
    font-style: italic;
  }

  .citation-doi {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--gold);
    text-decoration: none;
    border-bottom: 1px solid var(--gold);
    margin-left: 0.35rem;
    transition: opacity var(--transition-fast);
  }

  .citation-doi:hover {
    opacity: 0.7;
  }

  .citation-count {
    font-family: var(--font-mono);
    font-size: 0.6rem;
    color: var(--faded);
    margin-left: 0.5rem;
    letter-spacing: 0.3px;
  }

  /* ── Reduced motion ─────────────────────────────────── */
  @media (prefers-reduced-motion: reduce) {
    .deep-dive-wrapper {
      transition: none;
      grid-template-rows: 1fr;
      opacity: 1;
    }

    .expand-indicator {
      transition: none;
    }
  }

  /* ── Mobile: text flows naturally, no full-viewport sections ── */
  @media (max-width: 768px) {
    .thought-unit {
      min-height: auto;
      padding: 2rem 0;
    }

    .section-header {
      flex-direction: column;
      gap: 0.5rem;
    }

    .section-title {
      font-size: var(--text-lg);
    }

    .text-block {
      padding: 1.5rem;
    }
  }
</style>

<script>
  // Click-to-toggle Deep Dive expansion
  function initExpandToggle() {
    document.querySelectorAll('.expand-indicator').forEach((btn) => {
      btn.addEventListener('click', () => {
        const section = btn.closest('.thought-unit') as HTMLElement | null;
        if (!section) return;
        const wrapper = section.querySelector('.deep-dive-wrapper');
        const isExpanded = section.classList.contains('expanded');

        if (isExpanded) {
          section.classList.remove('expanded');
          if (wrapper) wrapper.setAttribute('aria-expanded', 'false');
        } else {
          section.classList.add('expanded');
          if (wrapper) wrapper.setAttribute('aria-expanded', 'true');
        }

        // Tell the canvas script to freeze the animation at its current state.
        window.dispatchEvent(new CustomEvent('section-toggle'));
      });
    });

    // Click-to-toggle Sources citations
    document.querySelectorAll('.citations-toggle').forEach((btn) => {
      btn.addEventListener('click', () => {
        const toggle = btn as HTMLButtonElement;
        const targetId = toggle.getAttribute('aria-controls');
        if (!targetId) return;
        const collapsible = document.getElementById(targetId);
        if (!collapsible) return;

        const isOpen = toggle.getAttribute('aria-expanded') === 'true';
        toggle.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
        collapsible.classList.toggle('is-open', !isOpen);

        // Tell the canvas script to freeze the animation at its current state.
        window.dispatchEvent(new CustomEvent('section-toggle'));
      });
    });
  }

  initExpandToggle();
  document.addEventListener('astro:after-swap', initExpandToggle);
</script>
